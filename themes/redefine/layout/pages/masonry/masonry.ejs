<script>
    // 全局变量，确保在所有地方都可用
    let masonryGrid, loadMoreBtn, loadingPlaceholder;
    let allImages = <%- JSON.stringify(images) %>;
    let currentIndex = 0;
    const batchSize = <%= initialLoadCount %>;

    // 在脚本顶部定义初始化函数，并立即尝试执行
    function initializeMasonry() {
        console.log("初始化瀑布流布局...");
        
        // 获取DOM元素
        masonryGrid = document.getElementById('masonry-grid');
        loadMoreBtn = document.getElementById('load-more-btn');
        loadingPlaceholder = document.querySelector('.loading-placeholder');
        
        if (!masonryGrid || !loadMoreBtn) {
            console.error("无法找到必要的DOM元素，将在100ms后重试");
            setTimeout(initializeMasonry, 100);
            return;
        }
        
        // 确保我们有图片数据
        if (!allImages || !Array.isArray(allImages) || allImages.length === 0) {
            console.error("图片数据无效:", allImages);
            return;
        }
        
        console.log(`找到 ${allImages.length} 张图片`);
        
        // 打乱图片数组顺序
        allImages = shuffleArray(allImages);
        
        // 隐藏加载占位符
        hideLoadingPlaceholder();
        
        // 设置事件监听器
        loadMoreBtn.addEventListener('click', function() {
            console.log("加载更多按钮被点击");
            loadMoreImages();
        });
        
        // 初始加载第一批图片
        loadMoreImages();
        
        // 窗口大小调整处理
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // 重新计算所有已加载图片的行跨度
                document.querySelectorAll('.masonry-item').forEach(item => {
                    setRowSpan(item);
                });
            }, 100);
        });
        
        console.log("瀑布流布局初始化完成");
    }
    
    // 打乱图片数组顺序
    function shuffleArray(array) {
        const newArray = [...array]; // 创建副本以避免修改原数组
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }
    
    // 隐藏加载占位符
    function hideLoadingPlaceholder() {
        if (loadingPlaceholder) {
            loadingPlaceholder.style.display = 'none';
        }
        if (masonryGrid) {
            masonryGrid.style.display = 'grid';
        }
    }
    
    // 创建图片元素
    function createImageElement(imageData) {
        try {
            const item = document.createElement('div');
            item.className = 'masonry-item';
            
            // 添加占位符和默认宽高比数据
            const aspectRatio = imageData.aspectRatio || 1.5; // 默认宽高比，如果没有提供
            
            item.innerHTML = `
                <div class="image-container" style="padding-bottom: ${(1/aspectRatio) * 100}%;">
                    <div class="image-placeholder"></div>
                    <img data-src="${imageData.image}" alt="${imageData.title || ''}" class="lazy-image">
                    <div class="image-overlay">
                        <div class="image-title">${imageData.title || ''}</div>
                        <div class="image-description">${imageData.description || ''}</div>
                    </div>
                </div>
            `;
            
            // 预加载图片以获取准确尺寸
            const tempImg = new Image();
            tempImg.onerror = function() {
                console.error("图片加载失败:", imageData.image);
            };
            tempImg.onload = function() {
                const actualRatio = tempImg.width / tempImg.height;
                const container = item.querySelector('.image-container');
                if (container) {
                    container.style.paddingBottom = `${(1/actualRatio) * 100}%`;
                    setRowSpan(item);
                }
            };
            tempImg.src = imageData.image;
            
            return item;
        } catch (error) {
            console.error("创建图片元素时出错:", error);
            return document.createElement('div'); // 返回空元素避免崩溃
        }
    }
    
    // 设置行跨度
    function setRowSpan(item) {
        try {
            const container = item.querySelector('.image-container');
            if (!container) return;
            
            const rowHeight = 40; // 与CSS中的grid-auto-rows保持一致
            const contentHeight = container.offsetHeight;
            const rowSpan = Math.max(1, Math.ceil(contentHeight / rowHeight));
            item.style.gridRow = `span ${rowSpan}`;
        } catch (error) {
            console.error("设置行跨度时出错:", error);
        }
    }
    
    // 懒加载图片
    function setupLazyLoading() {
        try {
            const lazyImages = document.querySelectorAll('.lazy-image');
            console.log(`设置${lazyImages.length}张图片的懒加载`);
            
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            
                            // 设置图片加载状态类
                            img.classList.add('loading');
                            
                            img.onload = function() {
                                img.classList.remove('lazy-image', 'loading');
                                // 图片加载后微调布局
                                const item = img.closest('.masonry-item');
                                if (item) {
                                    requestAnimationFrame(() => {
                                        setRowSpan(item);
                                    });
                                }
                                
                                // 隐藏占位符
                                const placeholder = img.previousElementSibling;
                                if (placeholder && placeholder.classList.contains('image-placeholder')) {
                                    placeholder.style.display = 'none';
                                }
                            };
                            
                            img.onerror = function() {
                                console.error("无法加载图片:", img.dataset.src);
                                img.classList.remove('loading');
                            };
                            
                            img.src = img.dataset.src;
                            imageObserver.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '200px 0px'
                });
                
                lazyImages.forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // 浏览器不支持 IntersectionObserver 的回退
                lazyImages.forEach(img => {
                    img.classList.add('loading');
                    img.onload = function() {
                        img.classList.remove('lazy-image', 'loading');
                        const item = img.closest('.masonry-item');
                        if (item) {
                            setRowSpan(item);
                        }
                        
                        // 隐藏占位符
                        const placeholder = img.previousElementSibling;
                        if (placeholder && placeholder.classList.contains('image-placeholder')) {
                            placeholder.style.display = 'none';
                        }
                    };
                    img.onerror = function() {
                        console.error("无法加载图片:", img.dataset.src);
                        img.classList.remove('loading');
                    };
                    img.src = img.dataset.src;
                });
            }
        } catch (error) {
            console.error("设置懒加载时出错:", error);
        }
    }
    
    // 加载更多图片
    function loadMoreImages() {
        try {
            console.log(`加载更多图片: 当前索引=${currentIndex}, 总数=${allImages.length}`);
            
            // 确保masonryGrid存在
            if (!masonryGrid) {
                console.error("无法找到masonry-grid元素");
                return;
            }
            
            // 每次加载前，对剩余的图片重新洗牌
            if (currentIndex < allImages.length) {
                const remainingImages = allImages.slice(currentIndex);
                const shuffledRemaining = shuffleArray(remainingImages);
                allImages = [...allImages.slice(0, currentIndex), ...shuffledRemaining];
            }
            
            const endIndex = Math.min(currentIndex + batchSize, allImages.length);
            console.log(`加载从${currentIndex}到${endIndex}的图片`);
            
            for (let i = currentIndex; i < endIndex; i++) {
                if (allImages[i]) {
                    const imageElement = createImageElement(allImages[i]);
                    masonryGrid.appendChild(imageElement);
                }
            }
            
            // 更新当前索引
            currentIndex = endIndex;
            
            // 启用懒加载
            setupLazyLoading();
            
            // 如果所有图片都已加载，隐藏"加载更多"按钮
            if (currentIndex >= allImages.length && loadMoreBtn) {
                loadMoreBtn.style.display = 'none';
            }
        } catch (error) {
            console.error("加载更多图片时出错:", error);
        }
    }

    // 尝试多种初始化方法，确保脚本在页面加载后执行
    // 方法1: DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded 已触发");
        initializeMasonry();
    });
    
    // 方法2: window.onload
    window.onload = function() {
        console.log("window.onload 已触发");
        initializeMasonry();
    };
    
    // 方法3: 立即执行检查
    (function() {
        // 如果DOM已经准备好，立即初始化
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            console.log("DOM已经准备好，立即初始化");
            setTimeout(initializeMasonry, 0);
        }
    })();
</script>